#include "../local-include/rtl.h"
#include <cpu/ifetch.h>
#include <cpu/decode.h>
#include <isa-all-instr.h>

def_all_THelper();

static uint32_t get_instr(Decode *s) {
  return s->isa.instr.val;
}

// decode operand helper
#define def_DopHelper(name) \
  void concat(decode_op_, name) (Decode *s, Operand *op, uint32_t val, bool flag)

static def_DopHelper(i) {
  op->imm = val;
  print_Dop(op->str, OP_STR_SIZE, (flag ? "0x%x" : "%d"), op->imm);
}

static def_DopHelper(r) {
  bool is_write = flag;
  static word_t zero_null = 0;
  op->preg = (is_write && val == 0) ? &zero_null : &gpr(val);
  print_Dop(op->str, OP_STR_SIZE, "%s", reg_name(val, 4));
}

static def_DHelper(IU) {
  decode_op_r(s, id_src1, s->isa.instr.iu.rs, false);
  decode_op_i(s, id_src2, s->isa.instr.iu.imm, true);
  decode_op_r(s, id_dest, s->isa.instr.iu.rt, true);
}

static def_DHelper(ld) {
  decode_op_r(s, id_src1, s->isa.instr.i.rs, false);
  decode_op_i(s, id_src2, s->isa.instr.i.simm, false);
  decode_op_r(s, id_dest, s->isa.instr.i.rt, true);
  print_Dop(id_src1->str, OP_STR_SIZE, "%d(%s)", id_src2->imm, reg_name(s->isa.instr.i.rs, 4));
}

static def_DHelper(st) {
  decode_op_r(s, id_src1, s->isa.instr.i.rs, false);
  decode_op_i(s, id_src2, s->isa.instr.i.simm, false);
  decode_op_r(s, id_dest, s->isa.instr.i.rt, false);
  print_Dop(id_src1->str, OP_STR_SIZE, "%d(%s)", id_src2->imm, reg_name(s->isa.instr.i.rs, 4));
}

static def_DHelper(lui) {
  decode_op_i(s, id_src1, s->isa.instr.iu.imm << 16, true);
  decode_op_r(s, id_dest, s->isa.instr.iu.rt, true);
}

#ifndef __ICS_EXPORT
static def_DHelper(I) {
  decode_op_r(s, id_src1, s->isa.instr.i.rs, false);
  decode_op_i(s, id_src2, s->isa.instr.i.simm, false);
  decode_op_r(s, id_dest, s->isa.instr.i.rt, true);
}

static def_DHelper(J) {
  vaddr_t target = (s->pc & 0xf0000000) | (s->isa.instr.j.target << 2);
  decode_op_i(s, id_dest, target, true);
}

static def_DHelper(R) {
  decode_op_r(s, id_src1, s->isa.instr.r.rs, false);
  decode_op_r(s, id_src2, s->isa.instr.r.rt, false);
  decode_op_r(s, id_dest, s->isa.instr.r.rd, true);
}

static def_DHelper(B) {
  sword_t offset = (s->isa.instr.i.simm << 2);
  decode_op_i(s, id_dest, s->pc + offset + 4, true);
  decode_op_r(s, id_src1, s->isa.instr.i.rs, false);
  decode_op_r(s, id_src2, s->isa.instr.i.rt, false);
  //s->snpc += 4; // skip the delay slot
}

static def_DHelper(shift) {
  decode_op_i(s, id_src1, s->isa.instr.r.sa, false);
  decode_op_r(s, id_src2, s->isa.instr.r.rt, false);
  decode_op_r(s, id_dest, s->isa.instr.r.rd, true);
}

static def_DHelper(cmov) {
  decode_op_r(s, id_src1, s->isa.instr.r.rs, false);
  decode_op_r(s, id_src2, s->isa.instr.r.rt, false);
  decode_op_r(s, id_dest, s->isa.instr.r.rd, true);
}

static def_DHelper(jal) {
  decode_J(s, width);
  id_src2->imm = s->pc + 8;
}

static def_DHelper(jalr) {
  decode_op_r(s, id_src1, s->isa.instr.r.rs, false);
  decode_op_r(s, id_dest, s->isa.instr.r.rd, true);
  id_src2->imm = s->pc + 8;
}

static def_DHelper(cp0) {
//  decode_op_r(s, id_src1, s->isa.instr.r.rs, false);
  decode_op_r(s, id_src2, s->isa.instr.r.rt, false);
  decode_op_i(s, id_dest, s->isa.instr.r.rd, false);
  print_Dop(id_dest->str, OP_STR_SIZE, "%s", cp0_name(id_dest->imm));
}

def_THelper(jr_dispatch) {
  if (s->isa.instr.r.rs == 31) return table_ret(s);
  return table_jr(s);
}
#endif

def_THelper(special) {
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 000000", shift, slli);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 000010", shift, srli);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 000011", shift, srai);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 000100",     R, sll);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 000110",     R, srl);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 000111",     R, sra);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 001000",     R, jr_dispatch);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 001001",  jalr, jalr);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 001010",  cmov, movz);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 001011",  cmov, movn);
  def_INSTR_TAB  ("?????? ????? ????? ?????????? 001100",        syscall);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 010000",     R, mfhi);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 010001",     R, mthi);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 010010",     R, mflo);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 010011",     R, mtlo);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 011000",     R, mult);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 011001",     R, multu);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 011010",     R, div);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 011011",     R, divu);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 100001",     R, add);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 100011",     R, sub);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 100100",     R, and);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 100101",     R, or);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 100110",     R, xor);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 100111",     R, nor);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 101010",     R, slt);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 101011",     R, sltu);
  return EXEC_ID_inv;
}

def_THelper(special2) {
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 000010", R, mul);
  def_INSTR_IDTAB("?????? ????? ????? ?????????? 100000", R, clz);
  return EXEC_ID_inv;
}

def_THelper(regimm) {
  def_INSTR_IDTAB("?????? ????? 00000 ????????????????", B, bltz);
  def_INSTR_IDTAB("?????? ????? 00001 ????????????????", B, bgez);
  return EXEC_ID_inv;
}

def_THelper(cop0) {
  def_INSTR_IDTAB("?????? 00000 ????? ????????????????", cp0, mfc0);
  def_INSTR_IDTAB("?????? 00100 ????? ????????????????", cp0, mtc0);
  def_INSTR_TAB  ("?????? 1 0000000000000000000 001000",      tlbp);
  def_INSTR_TAB  ("?????? 1 0000000000000000000 000010",      tlbwi);
  def_INSTR_TAB  ("?????? 1 0000000000000000000 000110",      tlbwr);
  def_INSTR_TAB  ("?????? 1 0000000000000000000 011000",      eret);
  return EXEC_ID_inv;
}

def_THelper(main) {
  def_INSTR_TAB  ("000000 ????? ????? ????????????????",      special);
  def_INSTR_TAB  ("000001 ????? ????? ????????????????",      regimm);
  def_INSTR_IDTAB("000010 ????? ????? ????????????????", J  , j);
  def_INSTR_IDTAB("000011 ????? ????? ????????????????", jal, jal);
  def_INSTR_IDTAB("000100 ????? ????? ????????????????", B  , beq);
  def_INSTR_IDTAB("000101 ????? ????? ????????????????", B  , bne);
  def_INSTR_IDTAB("000110 ????? ????? ????????????????", B  , blez);
  def_INSTR_IDTAB("000111 ????? ????? ????????????????", B  , bgtz);
  def_INSTR_IDTAB("001001 ????? ????? ????????????????", I  , addi);
  def_INSTR_IDTAB("001010 ????? ????? ????????????????", I  , slti);
  def_INSTR_IDTAB("001011 ????? ????? ????????????????", I  , sltui);
  def_INSTR_IDTAB("001100 ????? ????? ????????????????", IU , andi);
  def_INSTR_IDTAB("001101 ????? ????? ????????????????", IU , ori);
  def_INSTR_IDTAB("001110 ????? ????? ????????????????", IU , xori);
  def_INSTR_IDTAB("001111 ????? ????? ????????????????", lui, lui);

  def_INSTR_TAB  ("010000 ????? ????? ????????????????",      cop0);
  def_INSTR_TAB  ("011100 ????? ????? ????????????????",      special2);
  def_INSTR_IDTAB("100000 ????? ????? ????????????????", ld , lb);
  def_INSTR_IDTAB("100001 ????? ????? ????????????????", ld , lh);
  def_INSTR_IDTAB("100010 ????? ????? ????????????????", st , lwl);
  def_INSTR_IDTAB("100011 ????? ????? ????????????????", ld , lw);
  def_INSTR_IDTAB("100100 ????? ????? ????????????????", ld , lbu);
  def_INSTR_IDTAB("100101 ????? ????? ????????????????", ld , lhu);
  def_INSTR_IDTAB("100110 ????? ????? ????????????????", st , lwr);
  def_INSTR_IDTAB("101000 ????? ????? ????????????????", st , sb);
  def_INSTR_IDTAB("101001 ????? ????? ????????????????", st , sh);
  def_INSTR_IDTAB("101010 ????? ????? ????????????????", st , swl);
  def_INSTR_IDTAB("101011 ????? ????? ????????????????", st , sw);
  def_INSTR_IDTAB("101110 ????? ????? ????????????????", st , swr);
  def_INSTR_TAB  ("111100 ????? ????? ????????????????",      nemu_trap);
  return table_inv(s);
}

int isa_fetch_decode(Decode *s) {
  s->isa.instr.val = instr_fetch(&s->snpc, 4);
  int idx = table_main(s);

  s->type = INSTR_TYPE_N;
  switch (idx) {
    case EXEC_ID_j: case EXEC_ID_jal:
      s->jnpc = id_dest->imm; s->type = INSTR_TYPE_J; break;

    case EXEC_ID_beq: case EXEC_ID_bne: case EXEC_ID_blez:
    case EXEC_ID_bltz: case EXEC_ID_bgez: case EXEC_ID_bgtz:
      s->jnpc = id_dest->imm; s->type = INSTR_TYPE_B; break;

    case EXEC_ID_ret: case EXEC_ID_jr: case EXEC_ID_jalr:
    case EXEC_ID_eret: case EXEC_ID_syscall:
      s->type = INSTR_TYPE_I;
  }

  return idx;
}
